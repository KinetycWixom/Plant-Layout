<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Image Viewer — Smooth Zoom (No Flicker)</title>
<style>
  :root { --bg:#0f1115; --panel:#161a22; --text:#e8eaed; }
  html, body { height:100%; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; overflow:hidden; }
  .toolbar { position:fixed; inset:12px 12px auto 12px; z-index:10; background:var(--panel); border:1px solid #2a2f3a; border-radius:10px; display:flex; align-items:center; gap:8px; padding:8px 10px; box-shadow:0 8px 24px rgba(0,0,0,.35); }
  .toolbar button, .toolbar input[type="number"] { background:#202636; color:var(--text); border:1px solid #2d3342; border-radius:6px; padding:7px 10px; cursor:pointer; font-size:14px; }
  .toolbar button:hover { background:#253049; }
  .toolbar .spacer { width:1px; height:26px; background:#2a2f3a; margin:0 6px; }
  .toolbar .small { padding:5px 8px; font-size:13px; }
  #viewportWrapper { position:absolute; inset:0; overflow:hidden; background:#0e1117; }
  #canvasLayer { position:absolute; top:0; left:0; user-select:none; -webkit-user-drag:none; transform-origin:0 0; will-change: transform; }
  #loading { position:absolute; inset:0; display:grid; place-items:center; color:#9aa4b2; font-size:14px; }
  .grab { cursor:grab; } .grabbing { cursor:grabbing; }
</style>
</head>
<body>
  <div class="toolbar">
    <button id="prevBtn" class="small" disabled>◀</button>
    <span id="pageInfo">Page <input id="pageNumber" type="number" min="1" value="1" disabled style="width:64px"> / <span id="pageCount">1</span></span>
    <button id="nextBtn" class="small" disabled>▶</button>
    <div class="spacer"></div>
    <button id="fitPageBtn" class="small">Fit</button>
    <button id="fitWidthBtn" class="small">Width</button>
    <div class="spacer"></div>
    <button id="zoomOutBtn">−</button>
    <span id="zoomLabel" style="min-width:56px; text-align:center">97%</span>
    <button id="zoomInBtn">+</button>
    <div class="spacer"></div>
    <button id="rotateLBtn" class="small">⟲</button>
    <button id="rotateRBtn" class="small">⟳</button>
    <div class="spacer"></div>
    <button id="resetBtn">Reset</button>
  </div>
  <div id="viewportWrapper" class="grab">
    <div id="loading">Loading…</div>
    <canvas id="canvasLayer"></canvas>
  </div>
<script>
(function(){
  const params = new URLSearchParams(location.search);
  const DEFAULT_FILE = params.get('img') || 'document.png';

  const DEFAULT_SCALE    = 0.97;  // 97%
  const DEFAULT_ROTATION = 0;     // upright

  const MIN_SCALE        = 0.1;
  const MAX_SCALE        = 8.0;
  const ZOOM_SENSITIVITY = 0.04;
  const ZOOM_DEBOUNCE_MS = 160;
  const PAN_DEBOUNCE_MS  = 120;

  const canvas   = document.getElementById('canvasLayer');
  const ctx      = canvas.getContext('2d');
  const wrapper  = document.getElementById('viewportWrapper');
  const loading  = document.getElementById('loading');

  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomInBtn  = document.getElementById('zoomInBtn');
  const zoomLabel  = document.getElementById('zoomLabel');
  const rotateLBtn = document.getElementById('rotateLBtn');
  const rotateRBtn = document.getElementById('rotateRBtn');
  const resetBtn   = document.getElementById('resetBtn');
  const fitPageBtn = document.getElementById('fitPageBtn');
  const fitWidthBtn= document.getElementById('fitWidthBtn');

  // Disable page nav (single image)
  document.getElementById('prevBtn').disabled = true;
  document.getElementById('nextBtn').disabled = true;
  document.getElementById('pageNumber').disabled = true;
  document.getElementById('pageCount').textContent = '1';

  let img = new Image();
  let naturalW=0, naturalH=0;
  let scale = DEFAULT_SCALE;
  let rotation = DEFAULT_ROTATION;
  let panX=0, panY=0; let dragging=false, lastX=0, lastY=0;
  let renderScale = DEFAULT_SCALE; let cssScale=1; let zoomDebounceTimer=null; let panDebounceTimer=null;

  function updateZoomLabel(){ zoomLabel.textContent = Math.round(scale*100) + '%'; }
  function setCanvasTransform(){ canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${cssScale})`; }
  function resetPan(){ panX=0; panY=0; setCanvasTransform(); }
  function rotatedSize(w,h,rot){ const r=((rot%360)+360)%360; return (r%180===0)?{w,h}:{w:h,h:w}; }
  function fitWidth(){ const {w:vw}=rotatedSize(naturalW,naturalH,rotation); const w=wrapper.clientWidth; scale=Math.max(MIN_SCALE,Math.min(MAX_SCALE,w/vw)); updateZoomLabel(); }
  function fitPage(){ const {w:vw,h:vh}=rotatedSize(naturalW,naturalH,rotation); const w=wrapper.clientWidth, h=wrapper.clientHeight; scale=Math.max(MIN_SCALE,Math.min(MAX_SCALE,Math.min(w/vw,h/vh))); updateZoomLabel(); }

  async function renderImage({fit=false, fitMode='page', showLoading=true}={}){
    if (!img.complete || naturalW===0) return;
    if (showLoading) loading.style.display='grid';
    const dpr=Math.max(1, window.devicePixelRatio||1);
    const {w:vw,h:vh}=rotatedSize(naturalW,naturalH,rotation);
    if (fit) (fitMode==='width')?fitWidth():fitPage();
    const outW=Math.floor(vw*scale), outH=Math.floor(vh*scale);
    canvas.width=Math.floor(outW*dpr); canvas.height=Math.floor(outH*dpr);
    canvas.style.width=`${outW}px`; canvas.style.height=`${outH}px`;
    ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,outW,outH);
    ctx.save();
    switch(((rotation%360)+360)%360){
      case 0:   ctx.drawImage(img,0,0,naturalW,naturalH,0,0,outW,outH); break;
      case 90:  ctx.translate(outW,0); ctx.rotate(Math.PI/2); ctx.drawImage(img,0,0,naturalW,naturalH,0,0,outH,outW); break;
      case 180: ctx.translate(outW,outH); ctx.rotate(Math.PI);   ctx.drawImage(img,0,0,naturalW,naturalH,0,0,outW,outH); break;
      case 270: ctx.translate(0,outH);   ctx.rotate(3*Math.PI/2);ctx.drawImage(img,0,0,naturalW,naturalH,0,0,outH,outW); break;
    }
    ctx.restore();
    renderScale=scale; cssScale=1; setCanvasTransform();
    if (showLoading) loading.style.display='none';
  }

  async function openImage(url){
    loading.style.display='grid';
    await new Promise((resolve,reject)=>{ img.onload=resolve; img.onerror=reject; img.src=url; });
    naturalW=img.naturalWidth; naturalH=img.naturalHeight;
    rotation=DEFAULT_ROTATION; scale=DEFAULT_SCALE; renderScale=scale; cssScale=1; resetPan(); updateZoomLabel();
    await renderImage({showLoading:true});
  }

  const keySensitivity = 0.05;
  zoomInBtn.addEventListener('click',()=>{ const old=scale; scale=Math.min(MAX_SCALE, old*Math.exp(keySensitivity)); updateZoomLabel(); cssScale=scale/renderScale; setCanvasTransform(); clearTimeout(zoomDebounceTimer); zoomDebounceTimer=setTimeout(()=>renderImage({showLoading:false}), ZOOM_DEBOUNCE_MS); });
  zoomOutBtn.addEventListener('click',()=>{ const old=scale; scale=Math.max(MIN_SCALE, old/Math.exp(keySensitivity)); updateZoomLabel(); cssScale=scale/renderScale; setCanvasTransform(); clearTimeout(zoomDebounceTimer); zoomDebounceTimer=setTimeout(()=>renderImage({showLoading:false}), ZOOM_DEBOUNCE_MS); });
  rotateLBtn.addEventListener('click',()=>{ rotation=(rotation+270)%360; resetPan(); renderImage(); });
  rotateRBtn.addEventListener('click',()=>{ rotation=(rotation+90)%360;  resetPan(); renderImage(); });
  resetBtn.addEventListener('click',()=>{ scale=DEFAULT_SCALE; rotation=DEFAULT_ROTATION; renderScale=scale; cssScale=1; resetPan(); updateZoomLabel(); renderImage(); });
  fitWidthBtn.addEventListener('click',()=>{ resetPan(); renderImage({fit:true, fitMode:'width'}); });
  fitPageBtn.addEventListener('click',()=>{ resetPan(); renderImage({fit:true, fitMode:'page'}); });

  wrapper.addEventListener('wheel',(e)=>{ e.preventDefault(); let raw=(e.deltaMode===0)? e.deltaY/100 : (e.deltaMode===2? e.deltaY*3 : e.deltaY); const lines=Math.max(-3, Math.min(3, raw)); const oldScale=scale; scale=Math.max(MIN_SCALE, Math.min(MAX_SCALE, oldScale*Math.exp(-lines*ZOOM_SENSITIVITY))); if (scale===oldScale) return; updateZoomLabel(); const rect=wrapper.getBoundingClientRect(); const cx=e.clientX-rect.left-panX; const cy=e.clientY-rect.top-panY; const prevCss=cssScale; cssScale=scale/renderScale; const k=cssScale-prevCss; panX-=cx*k; panY-=cy*k; setCanvasTransform(); clearTimeout(zoomDebounceTimer); zoomDebounceTimer=setTimeout(()=>renderImage({showLoading:false}), ZOOM_DEBOUNCE_MS); }, {passive:false});
  wrapper.addEventListener('mousedown',(e)=>{ dragging=true; lastX=e.clientX; lastY=e.clientY; wrapper.classList.remove('grab'); wrapper.classList.add('grabbing'); });
  window.addEventListener('mousemove',(e)=>{ if(!dragging) return; const dx=e.clientX-lastX, dy=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; panX+=dx; panY+=dy; setCanvasTransform(); });
  window.addEventListener('mouseup',()=>{ if(!dragging) return; dragging=false; wrapper.classList.remove('grabbing'); wrapper.classList.add('grab'); clearTimeout(panDebounceTimer); panDebounceTimer=setTimeout(()=>renderImage({showLoading:false}), PAN_DEBOUNCE_MS); });
  window.addEventListener('resize',()=>renderImage({showLoading:false}));

  // Boot
  openImage(DEFAULT_FILE);
})();
</script>
</body>
</html>
