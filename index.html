<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PDF Viewer — Smooth Zoom (No Flicker)</title>
<style>
  :root { --bg:#0f1115; --panel:#161a22; --text:#e8eaed; }
  html, body { height:100%; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; overflow:hidden; }
  .toolbar { position:fixed; inset:12px 12px auto 12px; z-index:10; background:var(--panel); border:1px solid #2a2f3a; border-radius:10px; display:flex; align-items:center; gap:8px; padding:8px 10px; box-shadow:0 8px 24px rgba(0,0,0,.35); }
  .toolbar button, .toolbar input[type="number"] { background:#202636; color:var(--text); border:1px solid #2d3342; border-radius:6px; padding:7px 10px; cursor:pointer; font-size:14px; }
  .toolbar button:hover { background:#253049; }
  .toolbar .spacer { width:1px; height:26px; background:#2a2f3a; margin:0 6px; }
  .toolbar .small { padding:5px 8px; font-size:13px; }
  #viewportWrapper { position:absolute; inset:0; overflow:hidden; background:#0e1117; }
  #canvasLayer { position:absolute; top:0; left:0; user-select:none; -webkit-user-drag:none; transform-origin:0 0; will-change: transform; }
  #loading { position:absolute; inset:0; display:grid; place-items:center; color:#9aa4b2; font-size:14px; }
  .grab { cursor:grab; } .grabbing { cursor:grabbing; }
</style>
</head>
<body>
  <div class="toolbar">
    <button id="prevBtn" class="small" title="Previous page">◀</button>
    <span id="pageInfo">Page <input id="pageNumber" type="number" min="1" value="1" style="width:64px"> / <span id="pageCount">1</span></span>
    <button id="nextBtn" class="small" title="Next page">▶</button>

    <div class="spacer"></div>

    <button id="fitPageBtn" class="small" title="Fit page">Fit</button>
    <button id="fitWidthBtn" class="small" title="Fit width">Width</button>

    <div class="spacer"></div>

    <button id="zoomOutBtn" title="Zoom out (Ctrl+-)">−</button>
    <span id="zoomLabel" style="min-width:56px; text-align:center">155%</span>
    <button id="zoomInBtn" title="Zoom in (Ctrl+=)">+</button>

    <div class="spacer"></div>

    <button id="rotateLBtn" class="small" title="Rotate left (90°)">⟲</button>
    <button id="rotateRBtn" class="small" title="Rotate right (90°)">⟳</button>

    <div class="spacer"></div>

    <button id="resetBtn" title="Reset view">Reset</button>
  </div>

  <div id="viewportWrapper" class="grab">
    <div id="loading">Loading…</div>
    <canvas id="canvasLayer"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    if (!window['pdfjsLib']) { alert('PDF.js failed to load.'); }
  </script>

  <script>
  (function(){
    const DEFAULT_FILE = 'document.pdf';

    const DEFAULT_SCALE = 1.55;
    const DEFAULT_ROTATION = 270;

    const MIN_SCALE = 0.1;
    const MAX_SCALE = 8.0;
    const ZOOM_SENSITIVITY = 0.04;
    const ZOOM_DEBOUNCE_MS = 160;
    const PAN_DEBOUNCE_MS = 120;

    const canvas = document.getElementById('canvasLayer');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('viewportWrapper');
    const loading = document.getElementById('loading');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageNumber = document.getElementById('pageNumber');
    const pageCount = document.getElementById('pageCount');

    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomLabel = document.getElementById('zoomLabel');

    const rotateLBtn = document.getElementById('rotateLBtn');
    const rotateRBtn = document.getElementById('rotateRBtn');

    const resetBtn = document.getElementById('resetBtn');
    const fitPageBtn = document.getElementById('fitPageBtn');
    const fitWidthBtn = document.getElementById('fitWidthBtn');

    let pdfDoc = null; let currentPage = 1; let totalPages = 1;

    let scale = DEFAULT_SCALE;
    let rotation = DEFAULT_ROTATION;

    let panX = 0, panY = 0; let dragging = false, lastX = 0, lastY = 0;

    let renderScale = DEFAULT_SCALE;
    let cssScale = 1;
    let zoomDebounceTimer = null;
    let panDebounceTimer = null;

    function updateZoomLabel(){ zoomLabel.textContent = Math.round(scale*100) + '%'; }
    function setCanvasTransform(){ canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${cssScale})`; }
    function resetPan(){ panX = 0; panY = 0; setCanvasTransform(); }

    function fitWidth(viewport){
      const w = wrapper.clientWidth;
      let s = (rotation % 180 === 0) ? (w / viewport.width) : (w / viewport.height);
      scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, s));
      updateZoomLabel();
    }

    function fitPage(viewport){
      const w = wrapper.clientWidth, h = wrapper.clientHeight;
      const vw = (rotation % 180 === 0) ? viewport.width : viewport.height;
      const vh = (rotation % 180 === 0) ? viewport.height : viewport.width;
      const s = Math.min(w/vw, h/vh);
      scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, s));
      updateZoomLabel();
    }

    async function renderPage(num, {fit=false, fitMode='page', showLoading=true}={}){
      if (showLoading) loading.style.display = 'grid';
      const page = await pdfDoc.getPage(num);

      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const baseViewport = page.getViewport({ scale: 1, rotation });
      if (fit) { if (fitMode === 'width') fitWidth(baseViewport); else fitPage(baseViewport); }

      const viewport = page.getViewport({ scale: scale, rotation });

      canvas.width = Math.floor(viewport.width * dpr);
      canvas.height = Math.floor(viewport.height * dpr);
      canvas.style.width = Math.floor(viewport.width) + 'px';
      canvas.style.height = Math.floor(viewport.height) + 'px';

      const renderContext = { canvasContext: ctx, viewport, transform:[dpr,0,0,dpr,0,0] };
      await page.render(renderContext).promise;

      renderScale = scale;
      cssScale = 1;
      setCanvasTransform();

      if (showLoading) loading.style.display = 'none';
    }

    let rendering = false; let pendingRender = null;
    function queueRender(fit=false, fitMode='page', showLoading=true){ if (rendering){ pendingRender = {fit,fitMode,showLoading}; return; } doRender(fit,fitMode,showLoading); }
    async function doRender(fit=false, fitMode='page', showLoading=true){
      rendering = true;
      try { await renderPage(currentPage, {fit, fitMode, showLoading}); }
      finally {
        rendering = false;
        if (pendingRender){ const p = pendingRender; pendingRender=null; doRender(p.fit, p.fitMode, p.showLoading); }
      }
    }

    async function openFromUrl(url){
      loading.style.display = 'grid';
      const pdf = await pdfjsLib.getDocument(url).promise;
      pdfDoc = pdf; totalPages = pdf.numPages; pageCount.textContent = totalPages;
      currentPage = 1; rotation = DEFAULT_ROTATION; scale = DEFAULT_SCALE; renderScale = scale; cssScale = 1; resetPan(); updateZoomLabel();
      await doRender(false, 'page', true);
      pageNumber.value = currentPage;
    }

    prevBtn.addEventListener('click', () => { if (!pdfDoc || currentPage<=1) return; currentPage--; pageNumber.value=currentPage; resetPan(); queueRender(false,'page',true); });
    nextBtn.addEventListener('click', () => { if (!pdfDoc || currentPage>=totalPages) return; currentPage++; pageNumber.value=currentPage; resetPan(); queueRender(false,'page',true); });
    pageNumber.addEventListener('change', () => { if (!pdfDoc) return; let num = parseInt(pageNumber.value||'1',10); num = Math.max(1, Math.min(totalPages, num)); currentPage=num; resetPan(); queueRender(false,'page',true); });

    const keySensitivity = 0.05;
    zoomInBtn.addEventListener('click', () => { if (!pdfDoc) return; const old=scale; scale=Math.min(MAX_SCALE, old*Math.exp(keySensitivity)); updateZoomLabel(); cssScale = scale / renderScale; setCanvasTransform(); if (zoomDebounceTimer) clearTimeout(zoomDebounceTimer); zoomDebounceTimer=setTimeout(()=>queueRender(false,'page',false), ZOOM_DEBOUNCE_MS); });
    zoomOutBtn.addEventListener('click', () => { if (!pdfDoc) return; const old=scale; scale=Math.max(MIN_SCALE, old/Math.exp(keySensitivity)); updateZoomLabel(); cssScale = scale / renderScale; setCanvasTransform(); if (zoomDebounceTimer) clearTimeout(zoomDebounceTimer); zoomDebounceTimer=setTimeout(()=>queueRender(false,'page',false), ZOOM_DEBOUNCE_MS); });

    rotateLBtn.addEventListener('click', () => { if (!pdfDoc) return; rotation=(rotation+270)%360; resetPan(); queueRender(false,'page',true); });
    rotateRBtn.addEventListener('click', () => { if (!pdfDoc) return; rotation=(rotation+90)%360; resetPan(); queueRender(false,'page',true); });

    resetBtn.addEventListener('click', () => { if (!pdfDoc) return; scale=DEFAULT_SCALE; rotation=DEFAULT_ROTATION; renderScale=scale; cssScale=1; resetPan(); updateZoomLabel(); queueRender(false,'page',true); });

    fitWidthBtn.addEventListener('click', () => { if (!pdfDoc) return; resetPan(); queueRender(true, 'width', true); });
    fitPageBtn.addEventListener('click', () => { if (!pdfDoc) return; resetPan(); queueRender(true, 'page', true); });

    window.addEventListener('keydown', (e) => {
      if (!pdfDoc) return; const ctrl=e.ctrlKey||e.metaKey;
      if (ctrl && (e.key==='='||e.key==='+')) { e.preventDefault(); zoomInBtn.click(); }
      if (ctrl && (e.key==='-')) { e.preventDefault(); zoomOutBtn.click(); }
      if (ctrl && e.key==='0') { e.preventDefault(); resetBtn.click(); }
      if (e.key==='ArrowLeft' && !ctrl) { e.preventDefault(); prevBtn.click(); }
      if (e.key==='ArrowRight' && !ctrl) { e.preventDefault(); nextBtn.click(); }
      if (e.key.toLowerCase()==='f') { e.preventDefault(); fitPageBtn.click(); }
      if (e.key.toLowerCase()==='w') { e.preventDefault(); fitWidthBtn.click(); }
      if (e.key.toLowerCase()==='r') { e.preventDefault(); rotateRBtn.click(); }
    });

    window.addEventListener('wheel', (e) => { if (e.ctrlKey) e.preventDefault(); }, { passive:false });

    wrapper.addEventListener('wheel', (e) => {
      if (!pdfDoc) return;
      e.preventDefault();

      let raw = e.deltaY;
      if (e.deltaMode === 0) raw = raw / 100;   // pixels -> ~lines
      else if (e.deltaMode === 2) raw = raw * 3; // pages -> many lines
      const lines = Math.max(-3, Math.min(3, raw));

      const oldScale = scale;
      scale = oldScale * Math.exp(-lines * ZOOM_SENSITIVITY);
      scale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale));
      if (scale === oldScale) return;
      updateZoomLabel();

      const rect = wrapper.getBoundingClientRect();
      const cx = e.clientX - rect.left - panX;
      const cy = e.clientY - rect.top - panY;

      const prevCss = cssScale;
      cssScale = scale / renderScale;

      const k = cssScale - prevCss;
      panX -= cx * k;
      panY -= cy * k;
      setCanvasTransform();

      if (zoomDebounceTimer) clearTimeout(zoomDebounceTimer);
      zoomDebounceTimer = setTimeout(() => { queueRender(false,'page',false); }, ZOOM_DEBOUNCE_MS);
    }, { passive:false });

    wrapper.addEventListener('mousedown', (e)=>{ if(!pdfDoc) return; dragging=true; lastX=e.clientX; lastY=e.clientY; wrapper.classList.remove('grab'); wrapper.classList.add('grabbing'); });
    window.addEventListener('mousemove', (e)=>{ if(!dragging) return; const dx=e.clientX-lastX, dy=e.clientY-lastY; lastX=e.clientX; lastY=e.clientY; panX+=dx; panY+=dy; setCanvasTransform(); });
    window.addEventListener('mouseup', ()=>{ if(!dragging) return; dragging=false; wrapper.classList.remove('grabbing'); wrapper.classList.add('grab'); if (panDebounceTimer) clearTimeout(panDebounceTimer); panDebounceTimer=setTimeout(()=>queueRender(false,'page',false), PAN_DEBOUNCE_MS); });

    window.addEventListener('resize', ()=>{ if (!pdfDoc) return; queueRender(false,'page',false); });

    (async ()=>{
      try { await openFromUrl(DEFAULT_FILE); }
      catch(err){ loading.textContent='Could not load document.pdf. Ensure it exists next to index.html.'; }
    })();
  })();
  </script>
</body>
</html>